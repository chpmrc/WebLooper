<!DOCTYPE html>
<html>
    <body>
        <input type="text" id="connid">
        <input type="button" value="Connect" id="connect">
        <audio id="playback"></audio>

    </body>

    <script src="http://cdn.peerjs.com/0.3/peer.min.js"></script>
    <script>

        var peer = new Peer({key: 'bwipa5argudf5hfr'});
        var conn = null;
        var myData = [];

        var playbackEndCb = function(){
            if (myData.length == 0) return;
            console.log("Playing new chunk!");
            var chunk = myData.splice(0, 1)[0];
            console.log(chunk);
            playback.setAttribute('src', URL.createObjectURL(chunk));
            playback.play();
        }

        connect.onclick = function(){
            var id = connid.value;
            conn = peer.connect("weblooperroom", {
                reliable: true
            });

            conn.on('open', function(){
                console.log("Connection established");

                conn.on('data', function(data){
                    console.log("Receiving data...");
                    myData.push(new Blob([new Uint8Array(data)], {type : "audio/wav"}));
                    if (playback.paused){
                        console.log("Starting to play...");
                        playbackEndCb();
                        playback.ended = playbackEndCb;
                    }
                });

            });

            conn.on('error', function(err){
                console.log(error);
            });

        }
    </script>

</html>